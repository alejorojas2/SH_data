

# Validate mapping file
validate_mapping_file.py -b -m mapping_file_LSU_R1.txt
# -->  autocorrect for the naming rules; use the corrected file

# Trimm primer sequence and generate a new file with trimmed sequences from fastq files using cutadapt and for loop
#!/bin/bash
for file in $(<Analysis/list_LSU_R1.txt)
do
    cutadapt -g TTCTTGGTCATTTAGAGGAAGTAA -e 0.1 --discard-untrimmed --match-read-wildcards ${file} > ${file}.trimmed.fastq

done

# see how many read are left
for file in $(<Analysis/list_LSU_R1.txt)
do 
    grep -c ">" ${file}
    grep -c ">" ${file}.trimmed.fastq
done

#check quality control using fastqc
#fastqc /Users/vilgalyslab/Documents/mine_data_sunny/Mine_amplicon_data/mine_raw_files/test/M1D_ITS_S40_L001_R1_001.trimmed.fastq 

#using fastq quality filter in FASTX tool kit; trimm sequences and keep sequences with at least 90% of the bases achieving higher than 10 quality score
for file in $(<Analysis/list_LSU_R1.txt)
do
    fastq_quality_filter -i ${file}.trimmed.fastq -q 10 -p 90 | fastq_to_fasta > ${file}.trimmed.fasta

done

#repeat the trimming, quality_filter and fastq_to_fasta procedure with R2 documents
for file in $(<list_R2.txt)
do
    cutadapt -g AATCCTCCGCTTATTGATATGC -e 0.1 --discard-untrimmed --match-read-wildcards ${file}.fastq > ${file}.trimmed.fastq

done

#combine all fasta files into one big file using te validated mapping file (using cat / add_qiime_labels) 
mkdir fastas
mv *fasta fastas
add_qiime_labels.py -i fastas -m Analysis/mapping_file_LSU_R1_corrected.txt -c InputFileName

#identify chimeric seqs (need to use usearch?) & filter_fasta.py
identify_chimeric_seqs.py -i combined_seqs.fna -m usearch61 -r ~/sh_refs_qiime_ver7_dynamic_01.12.2017.fasta

#remove chimeric sequences based on the text file generated by the last step
filter_fasta.py -s usearch61_chimeras/chimeras.txt -f combined_seqs.fna -o combined_no_chimeras.fasta -n

#USEARCH dereplication and remove singletons
#skip this part I think
#usearch -fastx_uniques Fungi_R1_R2_combined.fasta -fastaout Fungi_R1_R2_uni.fasta -sizeout
#usearch -sortbysize Fungi_R1_R2_uni.fasta -minsize 2 -fastaout Fungi_R1_R2_ready.fasta

#pick otus
pick_otus.py -s 0.95 -i combined_no_chimeras.fasta -m usearch61 --optimal --minsize 2

#pick representative set
pick_rep_set.py -f combined_no_chimeras.fasta -i usearch61_picked_otus/combined_no_chimeras_otus.txt -m most_abundant

#assign taxonomy (SKIP)
#assign_taxonomy.py -i combined_no_chimeras.fasta_rep_set.fasta -m blast -t ~/sh_taxonomy_qiime_ver7_dynamic_01.12.2017.txt -r ~/sh_refs_qiime_ver7_dynamic_01.12.2017.fasta -o taxonomy_blast


#make otu table
make_otu_table.py -i usearch61_picked_otus/combined_no_chimeras_otus.txt -o otu_table.biom

#summarize taxa through plots
summarize_taxa_through_plots.py -i otu_table.biom -o SHtest_taxa_summary -m Analysis/mapping_file_ITS_R1_corrected.txt